'''–ö–æ–¥ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö ChromaDB'''


import os
from langchain_chroma import Chroma
from langchain_huggingface import HuggingFaceEmbeddings

# –ü—É—Ç—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¢–û–ß–ù–û —Ç–∞–∫–æ–π –∂–µ, –∫–∞–∫ –≤ create_db.py
CHROMA_PATH = "Data/chroma_db"

def main():
    # 1. –ü–†–û–í–ï–†–ö–ê –ü–£–¢–ò
    if not os.path.exists(CHROMA_PATH):
        print(f"‚ùå –û–®–ò–ë–ö–ê: –ü–∞–ø–∫–∞ {CHROMA_PATH} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!")
        print("–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏ create_db.py")
        return

    print("üß† –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª—å (—Å–µ–∫—É–Ω–¥–æ—á–∫—É)...")
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ –º–æ–¥–µ–ª—å, —á—Ç–æ –∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏!
    embeddings = HuggingFaceEmbeddings(model_name="intfloat/multilingual-e5-large")

    # 2. –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö –ë–ê–ó–ï
    print(f"üìÇ –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –±–∞–∑–µ –≤ '{CHROMA_PATH}'...")
    vectorstore = Chroma(
        persist_directory=CHROMA_PATH, 
        embedding_function=embeddings
    )

    # 3. –¢–ï–°–¢–û–í–´–ï –ó–ê–ü–†–û–°–´
    # –î–∞–≤–∞–π –∑–∞–¥–∞–¥–∏–º –≤–æ–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä–æ–≥–æ –ù–ï–¢ –≤ —Ç–µ–∫—Å—Ç–µ –Ω–∞–ø—Ä—è–º—É—é, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å "—É–º–Ω—ã–π –ø–æ–∏—Å–∫"
    queries = [
        "–ì–¥–µ —è –±—É–¥—É —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º–Ω—ã–µ –∫–æ–º–ø–ª–µ–∫—Å—ã?",  # –ü—Ä–æ–≤–µ—Ä–∏–º, –Ω–∞–π–¥–µ—Ç –ª–∏ 09.03.01 –∏ 09.03.04
        "–ö–∞–∫–∞—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å —Å–≤—è–∑–∞–Ω–∞ —Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º?",     # –ü—Ä–æ–≤–µ—Ä–∏–º, –ø–æ–¥—Ç—è–Ω–µ—Ç –ª–∏ –¥–∞–Ω–Ω—ã–µ –æ —Ü–µ–Ω–µ
        "–ö—É–¥–∞ –ø–æ—Å—Ç—É–ø–∏—Ç—å —Å —Ö–∏–º–∏–µ–π?"               # –ü—Ä–æ–≤–µ—Ä–∏–º –ø–æ–∏—Å–∫ –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º
    ]

    for q in queries:
        print(f"\n{'='*40}")
        print(f"‚ùì –í–û–ü–†–û–°: {q}")
        print(f"{'='*40}")
        
        # –ò—â–µ–º 2 —Å–∞–º—ã—Ö –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞
        results = vectorstore.similarity_search_with_score(q, k=3)

        for i, (doc, score) in enumerate(results):
            quality = "üü¢ –û–¢–õ–ò–ß–ù–û" if score < 0.4 else "üü° –ù–û–†–ú" if score < 0.8 else "üî¥ –¢–ê–ö –°–ï–ë–ï"
            
            print(f"\nüìÑ –î–æ–∫—É–º–µ–Ω—Ç ‚Ññ{i+1} | –û—Ü–µ–Ω–∫–∞ (Distance): {score:.4f} [{quality}]")
            print(f"üìå –ö–æ–¥: {doc.metadata.get('program_code')}")
            print(f"üìù –¢–µ–∫—Å—Ç: {doc.page_content[:100].replace(chr(10), ' ')}...") # –£–±–∏—Ä–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
            print("-" * 30)

if __name__ == "__main__":
    main()